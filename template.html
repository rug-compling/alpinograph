<!DOCTYPE html>
<html>
<!--WARNING-->

<head>
  <title>AlpinoGraph</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" type="text/css" href="main.css">
  <link rel="icon" href="../favicon.ico" type="image/ico">
  <script type="text/javascript" src="../jquery.js"></script>
  <script type="text/javascript">

    // TODO: spaghetticode ontwarren

    var qs = {};
    PART1;
    var corpus = '';
    var started = false;
    var haserror = false;
    var head = {};
    var hassentence = false;
    var lineno = 0;
    var hist = [];
    var histp = -1;
    var macrotxt = '';
    var macrodct = {};
    var paging = false;
    var thisOffset = 0;
    var prevOffset = 0;
    var nextOffset = 0;
    var currentTab = 2;
    var showPaging = false;
    var finished = false;

    function putHistory() {
      try {
        localStorage.setItem(
          'alpinograph',
          JSON.stringify(hist)
        );
      } catch (err) { }
    }

    function getHistory() {
      try {
        var storageContent = localStorage.getItem('alpinograph');
        if (storageContent !== undefined) {
          hist = JSON.parse(storageContent) || [];
        }
      } catch (err) { }
      setHistButtons();
    }

    function addToHist(q) {
      if (q == "") {
        return;
      }
      histp = 0;
      var pos = hist.indexOf(q);
      if (pos == 0) {
        return;
      }
      if (pos > 0) {
        hist.splice(pos, 1);
      }
      hist.unshift(q);
      while (hist.length > 50) {
        hist.pop();
      }
      putHistory();
      setHistButtons()
    }

    function setHistButtons() {
      var n = hist.length;
      if (histp < n - 1) {
        $('#butBack').prop('disabled', false);
      } else {
        $('#butBack').prop('disabled', true);

      }
      if (histp > 0) {
        $('#butForward').prop('disabled', false);
      } else {
        $('#butForward').prop('disabled', true);
      }
    }

    function move(step) {
      if (hist.length == 0) {
        histp = -1;
        return;
      }
      histp += step;
      if (histp >= hist.length) {
        histp = hist.length - 1;
      }
      if (histp < 0) {
        histp = 0;
      }
      var el = document.forms['alpgform'];
      el.elements['query1'].value = hist[histp];
      setHistButtons();
    }

    function macOpen() {
      $('#macros').removeClass('hide');
      return false;
    }

    function macClose() {
      $('#macros').addClass('hide');
      return false;
    }

    function macSave() {
      macrotxt = document.forms['alpgform'].elements['mactxt'].value;
      try {
        localStorage.setItem(
          'alpinograph_macros',
          macrotxt
        );
      } catch (err) { }
      parseMacros();
      disableSave();
      return false;
    }

    function macLoad() {
      try {
        var storageContent = localStorage.getItem('alpinograph_macros');
        if (storageContent !== undefined) {
          macrotxt = storageContent || "kleur = \"\"\"\n    'rood','groen','blauw'\n\"\"\"\n";
        }
      } catch (err) { }
      parseMacros();
      $('#mactxt').text(macrotxt);
      $('#mactxt').val(macrotxt);
      disableSave();
      return false;
    }

    function parseMacros() {
      macrodct = {};
      $('#macerr').text('');
      var ss = macrotxt.replace(/^\s*#.*/gm).match(/[a-zA-Z][_a-zA-Z0-9]*\s*=\s*"""(.|\n)*?"""/g);
      if (!ss) { return; }
      for (var i = 0; i < ss.length; i++) {
        var aa = ss[i].match(/([a-zA-Z][_a-zA-Z0-9]*)\s*=\s*"""((.|\n)*?)"""/);
        macrodct[aa[1]] = aa[2];
      }
      var keys = [];
      for (var key in macrodct) {
        keys.push(key);
      }
      for (var i = 0; i < keys.length; i++) {
        var going = true;
        var count = 0;
        while (going) {
          count += 1;
          var s = macrodct[keys[i]].replace(/%[a-zA-Z][_a-zA-Z0-9]*%/g, function (x) {
            var v = macrodct[x.substr(1, x.length - 2)];
            if (!v) {
              $('#macerr').append($('<p></p>').text('Fout: geen definitie gevonden voor ' + x));
            }
            return v || "MACRONOTFOUND";
          })
          if (macrodct[keys[i]] == s) {
            going = false;
          } else if (s.length > 65535 || count == 100) {
            $('#macerr').append($('<p></p>').text('Fout: te diepe recursie voor %' + keys[i] + '%'));
            macrodct[keys[i]] = 'MACROTOODEEP'
            going = false;
          } else {
            macrodct[keys[i]] = s;
          }
        }
      }
    }

    function enableSave() {
      $('#macrosave').removeAttr('disabled');
      $('#macroundo').removeAttr('disabled');
      $('#macrosave').addClass('bold');
    }

    function disableSave() {
      $('#macrosave').attr("disabled", "disabled");
      $('#macroundo').attr("disabled", "disabled");
      $('#macrosave').removeClass('bold');
    }

    function doPage(r) {
      $('#error').text('').addClass('hide');
      $('#time').text('');
      // $('#outputZinnen').text('');
      // $('#outputTable').text('');
      $('#runner').removeClass('hide');
      $('#wait').removeClass('hide');
      started = false;
      haserror = false;
      paging = true;
      finished = false;

      if (r < 0) {
        thisOffset = prevOffset;
      } else {
        thisOffset = nextOffset;
      }
      var f = document.forms['alpgform2'];
      f.elements['offset'].value = thisOffset;
      f.submit();
      return false;
    }

    window._fn = {
      setPaging: function (vorige, volgende, more) {
        finished = true;
        $('#wait').addClass('hide');
        if (vorige < 0 && !more) {
          $('#pages').addClass('hide');
          showPaging = false;
        } else {
          $('#pages').removeClass('hide');
          $('#butPrev').prop('disabled', vorige < 0);
          $('#butNext').prop('disabled', !more);
          prevOffset = vorige;
          nextOffset = volgende;
          showPaging = true;
        }
      },
      header: function (h) {
        head = h;
      },
      wordstart: function () {
        $('#butWoord').removeClass('hide').prop('disabled', false);
        $('#butLemma').removeClass('hide').prop('disabled', false);
        $('#outputWoorden').html('<p id="wmsg">bezig...</p><div id="wtab"></div>');
        $('#outputLemmas').html('<p id="lmsg">bezig...</p><div id="ltab"></div>');
      },
      row: function (r) {
        if (!started) {
          started = true;
          lineno = thisOffset;
          if (r.sentence) {
            hassentence = true;
            if (currentTab < 1) {
              $('#butZin').removeClass('hide').prop('disabled', true);
              $('#butTab').removeClass('hide').prop('disabled', false);
            }
          } else {
            hassentence = false;
          }
          $('#outputTable').html('<table id="tab"></table>');
          var tr = $('<tr></tr>');
          tr.append($('<th></th>'));
          for (var i = 0; i < head.length; i++) {
            tr.append($('<th></th>').text(head[i].name));
          }
          $('#tab').append(tr);
          if (hassentence) {
            $('#outputZinnen').html('<ol id="lst"></ol>');
          }
          if (currentTab < 1) {
            if (hassentence) {
              $('#outputZinnen').removeClass('hide');
            } else {
              $('#outputTable').removeClass('hide');
            }
          }
        }
        var tr = $('<tr></tr>');
        lineno = lineno + 1;
        tr.append($('<td></td>').text('' + lineno + '.'));
        for (var i = 0; i < r.fields.length; i++) {
          tr.append($('<td></td>').html(r.fields[i]));
        }
        $('#tab').append(tr);
        if (hassentence) {
          var a = $('<a href="bin/tree?' + r.args + '" target="_blank"></a>').html(r.sentence);
          $('#lst').append($('<li value="' + lineno + '"></li>').append(a));
        }
      },
      error: function (e) {
        $('#error').text(e).removeClass('hide');
        $('#time').text('');
        $('#runner').addClass('hide');
        $('#wait').addClass('hide');
        haserror = true;
      },
      time: function (t, p) {
        if (p == paging && !finished) {
          $('#time').text(t);
        }
      },
      done: function (p) {
        if (p == paging) {
          if (!started && !haserror) {
            $('#outputZinnen').removeClass('hide').text('Niets gevonden');
          }
        }
      },
      toomany: function () {
        $('#outputWoorden').html('<p>Te veel varianten</p>');
        $('#outputLemmas').html('<p>Te veel varianten</p>');
      },
      clearwords: function () {
        $('#wtab').html('<table id="tabw"><tr><th>aantal</th><th>woorden</th></tr></table>');
      },
      clearlemmas: function () {
        $('#ltab').html("<table id=\"tabl\"><tr><th>aantal</th><th>lemma's</th></tr></table>");
      },
      setwords: function (i, s) {
        var tr = $('<tr></tr>');
        tr.append($('<td></td>').html(i));
        tr.append($('<td></td>').text(s));
        $('#tabw').append(tr);
      },
      setlemmas: function (i, s) {
        var tr = $('<tr></tr>');
        tr.append($('<td></td>').html(i));
        tr.append($('<td></td>').text(s));
        $('#tabl').append(tr);
      },
      setwordsmsg: function (s) {
        $('#wmsg').html(s);
      },
      setlemmasmsg: function (s) {
        $('#lmsg').html(s);
      }
    }

    function q(tag) {
      /*
      $('#runner').addClass('hide');
      $('#error').text('').addClass('hide');
      $('#butZin').addClass('hide');
      $('#butWoord').addClass('hide');
      $('#butlemma').addClass('hide');
      $('#butTab').addClass('hide');
      $('#outputZinnen').text('').addClass('hide');
      $('#outputWoorden').text('').addClass('hide');
      $('#outputLemmas').text('').addClass('hide');
      $('#outputTable').text('').addClass('hide');
      */
      var el = document.forms['alpgform'];
      el.elements['query1'].value = qs[tag];
      el.scrollIntoView();
    }
    function formclear() {
      document.forms['alpgform'].elements['query1'].value = '';
    }

    function showZin() {
      currentTab = 2;
      $('#butZin').prop('disabled', true);
      $('#butWoord').prop('disabled', false);
      $('#butLemma').prop('disabled', false);
      $('#butTab').prop('disabled', false);
      $('#outputZinnen').removeClass('hide');
      $('#outputWoorden').addClass('hide');
      $('#outputLemmas').addClass('hide');
      $('#outputTable').addClass('hide');
      if (showPaging) {
        $('#pages').removeClass('hide');
      }
    }
    function showWoord() {
      currentTab = 2;
      $('#butZin').prop('disabled', false);
      $('#butWoord').prop('disabled', true);
      $('#butLemma').prop('disabled', false);
      $('#butTab').prop('disabled', false);
      $('#outputZinnen').addClass('hide');
      $('#outputWoorden').removeClass('hide');
      $('#outputLemmas').addClass('hide');
      $('#outputTable').addClass('hide');
      $('#pages').addClass('hide');
    }
    function showLemma() {
      currentTab = 3;
      $('#butZin').prop('disabled', false);
      $('#butWoord').prop('disabled', false);
      $('#butLemma').prop('disabled', true);
      $('#butTab').prop('disabled', false);
      $('#outputZinnen').addClass('hide');
      $('#outputWoorden').addClass('hide');
      $('#outputLemmas').removeClass('hide');
      $('#outputTable').addClass('hide');
      $('#pages').addClass('hide');
    }
    function showTab() {
      currentTab = 1;
      $('#butZin').prop('disabled', false);
      $('#butWoord').prop('disabled', false);
      $('#butLemma').prop('disabled', false);
      $('#butTab').prop('disabled', true);
      $('#outputZinnen').addClass('hide');
      $('#outputWoorden').addClass('hide');
      $('#outputLemmas').addClass('hide');
      $('#outputTable').removeClass('hide');
      if (showPaging) {
        $('#pages').removeClass('hide');
      }
    }
    function store() {
      $('#error').text('').addClass('hide');
      $('#time').text('');
      $('#butZin').addClass('hide');
      $('#butWoord').addClass('hide');
      $('#butLemma').addClass('hide');
      $('#butTab').addClass('hide');
      $('#outputZinnen').text('').addClass('hide');
      $('#outputWoorden').text('').addClass('hide');
      $('#outputLemmas').text('').addClass('hide');
      $('#outputTable').text('').addClass('hide');
      $('#runner').removeClass('hide');
      $('#wait').removeClass('hide');
      $('#pages').addClass('hide');
      currentTab = 0;
      thisOffset = 0;
      started = false;
      haserror = false;
      paging = false;
      showPaging = false;
      finished = false;

      var el = document.forms['alpgform'];
      corpus = el.elements['corpus'].value;
      var q1 = el.elements['query1'].value;
      var err = false;
      $('#error').text('');
      var q = q1.replace(/%[a-zA-Z][_a-zA-Z0-9]*%/g, function (x) {
        var v = macrodct[x.substr(1, x.length - 2)];
        if (!v) {
          err = true
          $('#error').append($('<p></p>').text('Fout: geen definitie gevonden voor ' + x)).removeClass('hide');
        }
        return v || "MACRONOTFOUND";
      })
      if (err) {
        return false;
      }
      el.elements['query'].value = q;
      addToHist(q1);
      var h = location.hash.replace('#', '');
      if (h != '') {
        location.hash = '';
      }
      var els = document.forms['alpgform2'].elements;
      els['corpus'].value = corpus;
      els['query'].value = q;
      return true;
    }
    function restore() {
      var h = location.hash.replace('#', '');
      if (h == '') {
        return;
      }
      var a = h.split(',');
      var el = document.forms['alpgform'];
      el.elements['query1'].value = decodeURIComponent(a[0]);
      if (a[1]) {
        el.elements['corpus'].value = a[1];
      }
      if (a[2]) {
        location.hash = a[0] + ',' + a[1];
        el.submit();
      }
    }
    function opslaan() {
      var el = document.forms['alpgform'];
      var c = el.elements['corpus'].value;
      var q1 = el.elements['query1'].value;
      var h = document.location + "#" +
        encodeURIComponent(q1).replace(/\(/g, '%28').replace(/\)/g, '%29') +
        ',' + c;
      var copyText = document.getElementById('txtOpslaan');
      copyText.value = h;
      $('#clip').removeClass('hide');
      return false;
    }
    function clipSelect() {
      var copyText = document.getElementById('txtOpslaan');
      copyText.select();
      copyText.setSelectionRange(0, 99999);
      document.execCommand("copy");
    }
    function clipClose() {
      $('#clip').addClass('hide');
    }
    $(document).ready(function () {
      restore();
      getHistory();
      macLoad();
      $('#mactxt').on('input propertychange', enableSave);
    });
  </script>
</head>

<body>
  <div class="nav">
    <input type="checkbox" id="menu" />
    <h1>AlpinoGraph</h1>
    <label for="menu" id="nav-icon">&#9776;</label>

    <div class="multi-level">
      <!--PART2-->
    </div>

  </div>

  <div id="main">
    <form id="alpgform" action="bin/alpg" method="post" accept-charset="utf-8"
      enctype="application/x-www-form-urlencoded" target="cframe" onsubmit="return store()">
      <div id="macros" class="hide">
        <textarea rows="20" name="mactxt" id="mactxt"></textarea>
        <div id="macerr"></div>
        <p>
          <button onClick="return macSave()" id="macrosave" disabled>Opslaan</button>
          <button onClick="return macLoad()" id="macroundo" disabled>Herstellen</button>
          <button onClick="return macClose()">Sluiten</button>
        </p>
      </div>
      <p>
        Corpus:
        <select name="corpus">
          <optgroup label="&mdash; handmatig verwerkte corpora &mdash;">
            <!--OPTMANUAL-->
          </optgroup>
          <optgroup label="&mdash; automatisch verwerkte corpora &mdash;">
            <!--OPTAUTO-->
          </optgroup>
        </select>
      </p>
      <p>
        <button onClick="return macOpen()" style="float:right">Macro's</button>
        <input type="button" disabled value="&lt;" id="butBack" onClick="move(1)"><input type="button" disabled
          value="&gt;" id="butForward" onClick="move(-1)">
        Query:<br>
        <textarea rows="20" name="query1" id="query1"></textarea>
        <input type="hidden" name="query" id="query">
      </p>
      <p>
        <button onClick="return opslaan()" style="float:right">Opslaan</button>
        <input type="submit" value="Doen">
        <input type="button" value="Wissen" onClick="formclear(form)">
      </p>
    </form>
    <div id="error" class="hide"></div>
    <div id="runner" class="hide">
      <span id="wait"><img src="images/busy.gif" alt="busy"></span>
      <span id="time"></span><img src="images/leeg.png" alt="">
    </div>
    <button class="hide" id="butTab" onClick="showTab()">tabel</button>
    <button class="hide" id="butZin" onClick="showZin()">zinnen</button>
    <button class="hide" id="butWoord" onClick="showWoord()">woorden</button>
    <button class="hide" id="butLemma" onClick="showLemma()">lemma's</button>
    <div id="outputZinnen" class="hide"></div>
    <div id="outputWoorden" class="hide"></div>
    <div id="outputLemmas" class="hide"></div>
    <div id="outputTable" class="hide"></div>
    <div id="pages" class="hide">
      <form id="alpgform2" action="bin/alpg" method="post" accept-charset="utf-8"
        enctype="application/x-www-form-urlencoded" target="cframe2">
        <input type="hidden" name="corpus" id="corpus2">
        <input type="hidden" name="query" id="query2">
        <input type="hidden" name="offset" id="offset2">
        <input type="hidden" name="paging" value="true" id="paging2">
        <input type="submit" id="butPrev" value="Vorige" onClick="return doPage(-1)">
        <input type="submit" id="butNext" value="Volgende" onClick="return doPage(1)">
      </form>
    </div>
  </div>
  <div id="foot">
    <a href="https://alpinograph.readthedocs.io/" target="_blank">help</a>
  </div>
  <iframe src="leeg.html" id="cframe" name="cframe" class="hide"></iframe>
  <iframe src="leeg.html" id="cframe2" name="cframe2" class="hide"></iframe>
  <div id="clip" class="hide">
    <p>
      <input type="text" id="txtOpslaan">
    </p>
    <p>
      <button onClick="clipSelect()">Naar klembord kopi&euml;ren</button>
      <button onClick="clipClose()">Sluiten</button>
    </p>
  </div>
</body>

</html>
